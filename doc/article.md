# PCIExpress 2.5GT/s analyzer своими руками

А не попробовать ли нам сделать PCI-Express анализатор?
Цены на профессиональные анализаторы не доступны простому разработчику, да и зачастую неподъёмны даже для небольших фирм. Описанное в данной статье устройстово, хоть и во многом уступает предложенным на рынке приборам, но, тем не менее, позволяет использовать его для отладки PCIExpress шины. Так же оно может быть полезно при диагностике компьютеров и для обучения.
В данной статье я предлагаю описание первого устройства, созданного для проверки концепции. В ней содержится краткое описание архитектуры PCIExpress, общая идея проекта и результаты тестирования первого прототипа.

PCIExpress шина это физическое соединение типа точка-точка, состоящее из х1, х2, х4, х8, х12, х16 или х32 каналов связи. Один канал связи представляет собой две дифференциальные пары, работающие одна на приём, другая на передачу данных. То есть х1-канал работает по 4 проводникам, а каналу х-32 необходимо уже 128. Канал связи всегда симметричен - то есть количество пар в обоих направлениях всегда одинаково.
Физически по каналу передаётся дифференциальный сигнал амплитудой от 800мВ до 1200мВ, постоянаая составляющая сигнала может варьироваться от 0 до 3.6В на стороне передатчика. Передатчик отвязан по постоянному току от приёмника с помощью конденсаторов. Частота передаваемого по каналам сигнала зависит от версии PCIExpress-протокола. 
PCIe 1.x работает на частоте 2.5 ГГц, что позволяет передавать по одному каналу до 250МБ/с.
PCIe 2.0	5ГГц, 500МБ/с
PCIe 3.0	8ГГц, 985МБ/с
PCIe 4.0	16ГГц, 1969ГБ/с
PCIe 5.0	32ГГц, 3938ГБ/с

PCIE спецификация определяет многоуровневую архитектуру. Эти уровни состоят из физического уровня (physical layer), канального уровня (data link layer) и уровня транцзакций (transaction layer).

Данные между устройствами передаются с помощью пакетов. Содержимое пакета формируется на уровне транзакций с использованием данных, полученных от ядра устройства и приложения.
Пакет хранится в буфере, готовый для передачи на нижние уровни. Такой пакет называется пакетом уровня транзакции (Transaction layer packet). Далее этот пакет поступает на уровень канала данных, где к нему присоединяется дополнительная информация, необходимая для проверки онибок на устройстве-приёмнике. Затем пакет кодируется на физическом уровне и передаётся по каналу связи приёмнику.




Основным компонентом анализатора явлеяется ПЛИС фирмы Lattice серии ECP5UM. ECP5UM имеет в своём распоряжении до четырёх PCS (Physical Coding Sublayer), которые умеют работать с физическим уровнем PCIE, GbE, SGMII и прочими протоколами, декодируют на лету 8b10b.
Основная идея работы устройства заключается в следующем. Каналы приёма PCS подключаются через ограничивающие усилители к линиям TX и RX PCIExpress-шины. Блок PCS декодирует поток данных, и на его выходе мы получаем сырые данные PCIExpress. 

Анализатор должен уметь декодировать 8b10b поток, дескремблировать полученные данные, распознавать начало и конец пакетов, 